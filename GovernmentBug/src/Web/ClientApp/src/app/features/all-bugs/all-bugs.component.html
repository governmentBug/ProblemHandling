<div class="bug-and-comments-wrapper">
  <!-- פאנל התגובות בצד שמאל -->
  <div class="comment-panel" *ngIf="isCommentsPanelOpen && selectedBug">
    <app-comment-panel [comments]="comments" [isAuthorizedToComment]="isAuthorizedToComment"
      (commentAdded)="onCommentAdded($event)" (commentDeleted)="onCommentDeleted($event)" (closePanel)="onClosePanel()">
    </app-comment-panel>
  </div>

  <!-- אזור הטבלה בימין -->
  <div class="bug-table-container" [class.narrow]="isCommentsPanelOpen && selectedBug">
    <div class="search-filter-bar">
      <input type="text" [(ngModel)]="searchText" (input)="applyFilterAndPage()"
        placeholder="חיפוש לפי כותרת, תקציר, שם יוצר או תאריך" />
      <select (change)="onSelectChange($event)" [value]="selectedFilterValue || selectedFilterType">
        <option *ngIf="!selectedFilterType" value="">-- בחר סינון --</option>
        <option *ngIf="!selectedFilterType" value="statusName">סטטוס</option>
        <option *ngIf="!selectedFilterType" value="priorityName">עדיפות</option>
        <option *ngIf="!selectedFilterType" value="categoryName">קטגוריה</option>

        <ng-container *ngIf="selectedFilterType">
          <option value="">-- בחר ערך --</option>
          <option *ngFor="let val of filterOptions[selectedFilterType]" [value]="val">
            {{ val }}
          </option>
        </ng-container>
      </select>
      <button *ngIf="selectedFilterType" (click)="resetFilter()">אפס / שנה סינון</button>
    </div>

    <h2 class="table-title">רשימת כל הבאגים</h2>

    <div class="table-wrapper">
      <table class="bug-table" dir="rtl">
        <thead>
          <tr>
            <th></th>
            <th><i class="fa fa-sort" (click)="sort('bugId')"></i> מזהה הבאג</th>
            <th><i class="fa fa-sort" (click)="sort('categoryName')"></i> קטגוריה</th>
            <th><i class="fa fa-sort" (click)="sort('title')"></i> שם הבאג</th>
            <th><i class="fa fa-sort" (click)="sort('priorityName')"></i> עדיפות</th>
            <th><i class="fa fa-sort" (click)="sort('statusName')"></i> סטטוס</th>
            <th><i class="fa fa-sort" (click)="sort('createdByUserFullName')"></i> נפתח ע"י</th>
            <th><i class="fa fa-sort" (click)="sort('createdDate')"></i> תאריך</th>
          </tr>
        </thead>
        <tbody>
          <ng-container *ngFor="let bug of bugs">
            <tr [class.selected]="selectedBug?.bugId === bug.bugId">
              <td>
                <button class="toggle-arrow" (click)="toggleBug(bug, $event)">
                  <i class="fas fa-chevron-left" [class.rotated]="selectedBug?.bugId === bug.bugId"></i>
                </button>
              </td>
              <td>{{ bug.bugId }}</td>
              <td>{{ bug.categoryName }}</td>
              <td>{{ bug.title }}</td>
              <td>
                <span [ngClass]="{
  'priority-low': bug.priorityName === 'נמוכה',
  'priority-medium': bug.priorityName === 'בינונית',
  'priority-high': bug.priorityName === 'גבוהה',
  'priority-critical': bug.priorityName === 'קריטית'
}">
                  {{ bug.priorityName === 'נמוכה' ? '★' :
                  bug.priorityName === 'בינונית' ? '★★' :
                  bug.priorityName === 'גבוהה' ? '★★★' : '★★★★' }}
                </span>

              </td>
              <td>
                <span [ngClass]="{
  'status-open': bug.statusName === 'פתוח',
  'status-active': bug.statusName === 'פעיל',
  'status-close': bug.statusName === 'סגור',
  'status-cancelled': bug.statusName === 'בוטל',
  'status-close-without-opening': bug.statusName === 'נסגר מבלי להיפתח'
}">
                  {{ bug.statusName }}
                </span>
              </td>
              <td>{{ bug.createdByUserFullName }}</td>
              <td>{{ bug.createdDate | date:'dd/MM/yyyy' }}</td>
            </tr>

            <tr *ngIf="selectedBug?.bugId === bug.bugId" class="bug-detail-row">
              <td colspan="8">
                <app-bug-detail [bug]="selectedBug" [AuthorizedUser]="isAuthorizedToComment"
                  (bugChanged)="onBugChanged()">
                </app-bug-detail>
              </td>
            </tr>
          </ng-container>
        </tbody>
      </table>
    </div>

    <div class="pagination-controls">
      <button (click)="prevPage()" [disabled]="currentPage === 1">הקודם</button>
      <span>עמוד {{ currentPage }}</span>
      <button (click)="nextPage()">הבא</button>
    </div>
  </div>
</div>